<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Sanborn Building Image Viewer Beta</title>  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/openseadragon@4.1.0/build/openseadragon/openseadragon.min.js"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.28/"></script>
  <style>
    /*Map container*/
#viewDiv {
  position: absolute;
  top: 0;
  bottom: 0;        
  padding: 0;
  margin-top: 56px;        
  width: 100%;
}

.esri-ui .esri-popup  {
  display:  none !important;
 }  

 #offcanvasRight {
  width: 50%;
  margin-top: 56px;
 }   

 .responsive {
  width: 100%;
  height: auto;
}

.navbar {
  height: 56px !important;
  --bs-navbar-padding-y: 0 !important;
}

.navbar-brand {
  padding: 0 0px;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;   
}


.bg-body-tertiary {
  background-color: #363636 !important; 
}

@keyframes pulseAnimation {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(2); /* Increase the size a bit */
    opacity: 0.7; /* Slightly transparent */
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.pulsing-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: red;
  position: absolute;
  transform: translate(-50%, -50%); /* Center the dot */
  animation: pulseAnimation 2s infinite; /* Use the defined animation */
}ion: absolute;
  }
  </style>
  <script>
  require([
    "esri/config",
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/layers/TileLayer",
    "esri/core/reactiveUtils"
  ], function(esriConfig, Map, MapView, FeatureLayer, TileLayer,  reactiveUtils) {

  const bsOffcanvas = new bootstrap.Offcanvas('#offcanvasRight')

  esriConfig.apiKey = "YOUR_API_KEY";

  const viewer = OpenSeadragon({
    id: "openseadragon1",
    prefixUrl: "https://cdn.jsdelivr.net/npm/openseadragon@2.4/build/openseadragon/images/",
    maxZoomLevel: null, 
    tileSources: {
      type: "image",
      url: "https://cchi-iif.mtu.edu/iiif/3/OBECTID18.jpg/full/max/0/default.jpg"
    },   
  });

  bsOffcanvas.show();

  const map = new Map({
    basemap: "satellite"
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [-88.461825, 47.246305],
    zoom: 19
  });
  
  const footprints_1908 = new FeatureLayer({
    url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/sanborn_1908_footprints_with_image_coords/FeatureServer/0",
    popupEnabled: true,
    definitionExpression: "img_coords is not null",
    outFields: ["*"]
  });

  map.add(footprints_1908, 1);

  const sanborn_1908 = new TileLayer({
    url: "https://portal1-geo.sabu.mtu.edu:6443/arcgis/rest/services/KeweenawHSDI/KeTT_1908_FIPS/MapServer"
  });

  map.add(sanborn_1908, 0);

  // Create a popup template for the photos layer
  footprints_1908.popupTemplate = {
    title:'footprint',
    content: "Description"    
  };
  
  viewer.addHandler('open', function() {
    var tiledImage = viewer.world.getItemAt(0);
    var imgWidth = tiledImage.getContentSize().x;
    var imgHeight = tiledImage.getContentSize().y;
    
    console.log("Image dimensions in pixels:", imgWidth, imgHeight);

  });

  viewer.addHandler('canvas-click', function(event) {
    // The canvas-click event gives us a position in web coordinates.
    var webPoint = event.position;

    // Convert that to viewport coordinates, the lingua franca of OpenSeadragon coordinates.
    var viewportPoint = viewer.viewport.pointFromPixel(webPoint);

    // Convert from viewport coordinates to image coordinates.
    var imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);

    // Show the results.
    console.log(webPoint.toString(), viewportPoint.toString(), imagePoint.toString());
  });

  // the image does not have an overlay
  var overlay = false;

 // watch for a click on the building footprints  
 reactiveUtils.watch(
  () => view.popup.selectedFeature,
  (graphic) => {
    if (graphic) {  
    bsOffcanvas.show();  	
    console.log(graphic);
    //const imgDesc = graphic.attributes.image_desc;
    //const imgUrl = graphic.attributes.image_url;
    const imgCoords = graphic.attributes.img_coords;
    const address = graphic.attributes.address;
    const place_name = graphic.attributes.place_nam;

    if (imgCoords != null) {

    const coordsArr = imgCoords.split(",");
    console.log(coordsArr);

    console.log(overlay);

    // if there is an overlay on the image, remove it
    if (overlay == true) {
      viewer.removeOverlay("map-pin");        
    } 

    const tiledImage = viewer.world.getItemAt(0);

    // Convert string values to floats
    const imageX = parseFloat(coordsArr[0]);
    const imageY = parseFloat(coordsArr[1]);

    console.log(imageX, imageY);

 // Convert the image coordinates to viewport coordinates
 var viewportPoint = tiledImage.imageToViewportCoordinates(new OpenSeadragon.Point(imageX, imageY));

 // Create an HTML element for the pin
  var pin = document.createElement("img");
  pin.src = "https://upload.wikimedia.org/wikipedia/commons/d/d1/Google_Maps_pin.svg"; // URL to the map marker pin image
  pin.id = "map-pin";
  pin.className = "highlight";

   // Style your pin as needed (optional)
 // pin.style.width = "32px"; // Example size, adjust as needed
 // pin.style.height = "32px";
 // pin.style.transform = "translate(-50%, -100%)"; // Adjust the pin position relative to the point

   // Create an HTML element for the dot
  var dot = document.createElement("div");
  dot.className = "pulsing-dot";
  
  // Adjust as necessary to center the dot over the point
  dot.style.transform = "translate(-50%, -50%)";

// Add the overlay with normalized coordinates
viewer.addOverlay({
  element: pin,
  location: viewportPoint 
});    

var deltaX = .2; // Example value, adjust based on how much area you want to show
var deltaY = .2; // Example value, adjust based on how much area you want to show
var bounds = new OpenSeadragon.Rect(viewportPoint.x - deltaX, viewportPoint.y - deltaY, 2 * deltaX, 2 * deltaY);

viewer.viewport.fitBounds(bounds, true); // The second parameter enables smooth animation
document.getElementById("title").innerHTML = address + ", " + place_name;

// Center the viewport on the point
//viewer.viewport.panTo(viewportPoint, true);
// zoom to the point on the image
//viewer.viewport.zoomTo(2, viewportPoint, true);
   // now that there is an overlay set the variable to true 
    overlay = true;
  }
}
  });

  });
</script>

</head>
<body>
  <nav class="navbar bg-body-tertiary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <img src="kettlogo.png" alt="Logo" width="50" height="50" class="d-inline-block align-text-top">
      <span id="apptitle">Historic Building Image Viewer</span>
    </a>
  </div>
</nav>
  <div id="viewDiv"></div>
  <!-- <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">Toggle right offcanvas</button> -->

<div class="offcanvas offcanvas-end" tabindex="-1" data-bs-scholl="true" data-bs-backdrop="false" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasRightLabel"><div id="title"></div></h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
   <div id='openseadragon1' class-="responsive"></div>
  </div>
</div>
</body>
</html>